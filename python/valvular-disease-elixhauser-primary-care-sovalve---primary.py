# David Metcalfe, James Masters, Antonella Delmestri, Andrew Judge, Daniel Perry, Cheryl Zogg, Belinda Gabbe, Matthew Costa, 2024.

import sys, csv, re

codes = [{"code":"791Dy00","system":"readv2"},{"code":"G540.14","system":"readv2"},{"code":"P6X..00","system":"readv2"},{"code":"7915300","system":"readv2"},{"code":"7912300","system":"readv2"},{"code":"G11..11","system":"readv2"},{"code":"ZV45H00","system":"readv2"},{"code":"791y.00","system":"readv2"},{"code":"7918300","system":"readv2"},{"code":"G540.15","system":"readv2"},{"code":"G141.00","system":"readv2"},{"code":"7916z00","system":"readv2"},{"code":"G12z.00","system":"readv2"},{"code":"G114.00","system":"readv2"},{"code":"7931000","system":"readv2"},{"code":"P651.00","system":"readv2"},{"code":"G541z00","system":"readv2"},{"code":"7917y00","system":"readv2"},{"code":"7911500","system":"readv2"},{"code":"7914411","system":"readv2"},{"code":"7918200","system":"readv2"},{"code":"Gyu1100","system":"readv2"},{"code":"791D.00","system":"readv2"},{"code":"791A.00","system":"readv2"},{"code":"7911100","system":"readv2"},{"code":"7913300","system":"readv2"},{"code":"7918500","system":"readv2"},{"code":"791..00","system":"readv2"},{"code":"7912511","system":"readv2"},{"code":"A932200","system":"readv2"},{"code":"G11..00","system":"readv2"},{"code":"7911600","system":"readv2"},{"code":"G541.00","system":"readv2"},{"code":"791C500","system":"readv2"},{"code":"7913z00","system":"readv2"},{"code":"7919500","system":"readv2"},{"code":"7911y00","system":"readv2"},{"code":"Pyu2200","system":"readv2"},{"code":"G140z00","system":"readv2"},{"code":"A932300","system":"readv2"},{"code":"G543.00","system":"readv2"},{"code":"G544X00","system":"readv2"},{"code":"7915000","system":"readv2"},{"code":"7914300","system":"readv2"},{"code":"7915y00","system":"readv2"},{"code":"G542X00","system":"readv2"},{"code":"Gyu1200","system":"readv2"},{"code":"7910.12","system":"readv2"},{"code":"24G..00","system":"readv2"},{"code":"P641.00","system":"readv2"},{"code":"G542.00","system":"readv2"},{"code":"G542z00","system":"readv2"},{"code":"7910100","system":"readv2"},{"code":"7915.00","system":"readv2"},{"code":"G54z.00","system":"readv2"},{"code":"7911000","system":"readv2"},{"code":"P601000","system":"readv2"},{"code":"7N40000","system":"readv2"},{"code":"7910000","system":"readv2"},{"code":"7918y00","system":"readv2"},{"code":"7910z00","system":"readv2"},{"code":"P60zz00","system":"readv2"},{"code":"7911411","system":"readv2"},{"code":"7913411","system":"readv2"},{"code":"7914211","system":"readv2"},{"code":"7918100","system":"readv2"},{"code":"7917.00","system":"readv2"},{"code":"ZV42200","system":"readv2"},{"code":"7N40300","system":"readv2"},{"code":"7914.11","system":"readv2"},{"code":"G13z.00","system":"readv2"},{"code":"G542200","system":"readv2"},{"code":"G544000","system":"readv2"},{"code":"7910411","system":"readv2"},{"code":"7914100","system":"readv2"},{"code":"7911.12","system":"readv2"},{"code":"7911.00","system":"readv2"},{"code":"P63..00","system":"readv2"},{"code":"7912000","system":"readv2"},{"code":"P6yyC00","system":"readv2"},{"code":"SP00200","system":"readv2"},{"code":"P652.00","system":"readv2"},{"code":"7918.00","system":"readv2"},{"code":"G12..00","system":"readv2"},{"code":"7914212","system":"readv2"},{"code":"7912100","system":"readv2"},{"code":"7919z00","system":"readv2"},{"code":"791z.00","system":"readv2"},{"code":"7914.00","system":"readv2"},{"code":"P60z.00","system":"readv2"},{"code":"G54z000","system":"readv2"},{"code":"G141z00","system":"readv2"},{"code":"7915200","system":"readv2"},{"code":"7915100","system":"readv2"},{"code":"P601z00","system":"readv2"},{"code":"7918z00","system":"readv2"},{"code":"G54z100","system":"readv2"},{"code":"7919.00","system":"readv2"},{"code":"P6yy700","system":"readv2"},{"code":"7914200","system":"readv2"},{"code":"791Ay00","system":"readv2"},{"code":"P64..00","system":"readv2"},{"code":"7912z00","system":"readv2"},{"code":"7N40.00","system":"readv2"},{"code":"TB01200","system":"readv2"},{"code":"G540z00","system":"readv2"},{"code":"ZVu6e00","system":"readv2"},{"code":"G54zz00","system":"readv2"},{"code":"G540.12","system":"readv2"},{"code":"Gyu5800","system":"readv2"},{"code":"P60..00","system":"readv2"},{"code":"P600.00","system":"readv2"},{"code":"7916.00","system":"readv2"},{"code":"7914000","system":"readv2"},{"code":"G543400","system":"readv2"},{"code":"G11z.00","system":"readv2"},{"code":"7918000","system":"readv2"},{"code":"G54z300","system":"readv2"},{"code":"G544200","system":"readv2"},{"code":"P60z000","system":"readv2"},{"code":"G541400","system":"readv2"},{"code":"14S4.00","system":"readv2"},{"code":"7914y00","system":"readv2"},{"code":"7913.12","system":"readv2"},{"code":"7910300","system":"readv2"},{"code":"P64z.00","system":"readv2"},{"code":"7917z00","system":"readv2"},{"code":"7N40100","system":"readv2"},{"code":"G54z014","system":"readv2"},{"code":"A932.11","system":"readv2"},{"code":"G13..00","system":"readv2"},{"code":"P640.00","system":"readv2"},{"code":"SP00400","system":"readv2"},{"code":"7A65y00","system":"readv2"},{"code":"G54z013","system":"readv2"},{"code":"7918400","system":"readv2"},{"code":"G541700","system":"readv2"},{"code":"7919y00","system":"readv2"},{"code":"7913100","system":"readv2"},{"code":"7910200","system":"readv2"},{"code":"7A65100","system":"readv2"},{"code":"7914z00","system":"readv2"},{"code":"A932100","system":"readv2"},{"code":"7915z00","system":"readv2"},{"code":"G13y.00","system":"readv2"},{"code":"7910.00","system":"readv2"},{"code":"7910214","system":"readv2"},{"code":"7910213","system":"readv2"},{"code":"7912.00","system":"readv2"},{"code":"G544.00","system":"readv2"},{"code":"7913y00","system":"readv2"},{"code":"G140.00","system":"readv2"},{"code":"7913200","system":"readv2"},{"code":"Gyu5600","system":"readv2"},{"code":"7913.00","system":"readv2"},{"code":"SyuK611","system":"readv2"},{"code":"G54..11","system":"readv2"},{"code":"791B.00","system":"readv2"},{"code":"P601.00","system":"readv2"},{"code":"7N40z00","system":"readv2"},{"code":"7912y00","system":"readv2"},{"code":"P6W..00","system":"readv2"},{"code":"Pyu2H00","system":"readv2"},{"code":"7916y00","system":"readv2"},{"code":"G543z00","system":"readv2"},{"code":"7919600","system":"readv2"},{"code":"Pyu2G00","system":"readv2"},{"code":"7912.11","system":"readv2"},{"code":"7912200","system":"readv2"},{"code":"P6z0.00","system":"readv2"},{"code":"P602100","system":"readv2"},{"code":"G540300","system":"readv2"},{"code":"Gyu5A00","system":"readv2"},{"code":"7913000","system":"readv2"},{"code":"7911300","system":"readv2"},{"code":"G113.00","system":"readv2"},{"code":"P6yy.11","system":"readv2"},{"code":"7910y00","system":"readv2"},{"code":"G544100","system":"readv2"},{"code":"G540200","system":"readv2"},{"code":"G541600","system":"readv2"},{"code":"Gyu1000","system":"readv2"},{"code":"Gyu5D00","system":"readv2"},{"code":"7911z00","system":"readv2"},{"code":"7N40200","system":"readv2"},{"code":"7911200","system":"readv2"},{"code":"G540.00","system":"readv2"},{"code":"Gyu5500","system":"readv2"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('valvular-disease-elixhauser-primary-care-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["valvular-disease-elixhauser-primary-care-sovalve---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["valvular-disease-elixhauser-primary-care-sovalve---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["valvular-disease-elixhauser-primary-care-sovalve---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
